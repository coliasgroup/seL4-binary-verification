spec-version: 0.36.0
name: sel4-bv
version: 0.1.0.0
synopsis: TODO
description: TODO
license: BSD-2-Clause
author: Nick Spinale (Colias Group, LLC)
maintainer: Nick Spinale <nick@nickspinale.com>
copyright: Copyright (c) 2025 Colias Group, LLC

language: GHC2024

default-extensions:
  - FunctionalDependencies
  # records
  - DuplicateRecordFields
  - NoFieldSelectors
  - OverloadedLabels
  - OverloadedRecordDot

ghc-options:
  - -Wall
  - -Wno-unused-do-bind

_exe-ghc-options: &exe-ghc-options
  - -threaded
  - -rtsopts

_test-ghc-options: &test-ghc-options
  - -threaded
  - -rtsopts
  - -with-rtsopts=-N

dependencies:
  - base
  # ghc
  - array
  - binary
  - bytestring
  - containers
  - deepseq
  - directory
  - exceptions
  - filepath
  - mtl
  - process
  - stm
  - text
  - transformers
  # other
  - async
  - monad-logger
  - optics
  - parallel
  - safe-exceptions
  - transformers-base
  - unliftio-core
  - vector

internal-libraries:

  smtlib2:
    visibility: public
    source-dirs: components/smtlib2
    exposed-modules:
      - BV.SMTLIB2
      - BV.SMTLIB2.Command
      - BV.SMTLIB2.Monad
      - BV.SMTLIB2.SExpr
      - BV.SMTLIB2.SExpr.Show
      - BV.SMTLIB2.SExpr.Read
      - BV.SMTLIB2.SExpr.Build
      - BV.SMTLIB2.SExpr.Build.Pretty
      - BV.SMTLIB2.SExpr.Parse.Attoparsec
      - BV.SMTLIB2.SExpr.Parse.Megaparsec
    dependencies:
      - attoparsec
      - megaparsec

  smtlib2-process:
    visibility: public
    source-dirs: components/smtlib2-process
    exposed-modules:
      - BV.SMTLIB2.Process
    dependencies:
      - sel4-bv:smtlib2
      # external
      - conduit
      - conduit-extra

  logging:
    visibility: public
    source-dirs: components/logging
    exposed-modules:
      - BV.Logging
    dependencies:
      - aeson
      - attoparsec
      - attoparsec-aeson
  
  network-transport-static:
    visibility: public
    source-dirs: components/network-transport-static
    exposed-modules:
      - Network.Transport.Static
      - Network.Transport.Static.Utils
    dependencies:
      - network-transport

  core:
    visibility: public
    source-dirs: components/core
    exposed-modules:
      - BV.Core.DecorateProofScript
      - BV.Core.ExecuteSMTProofChecks
      - BV.Core.Logic
      - BV.Core.ModelConfig
      - BV.Core.Prelude
      - BV.Core.RepGraph
      - BV.Core.Stages
      - BV.Core.Structs
      - BV.Core.Types
      - BV.Core.Types.Extras.Expr # TODO
      - BV.Core.Types.Extras.Problem # TODO
      - BV.Core.Types.Extras.Program # TODO
      - BV.Core.Types.Extras.ProofCheck # TODO
      - BV.Core.Types.Extras.SExprWithPlaceholders # TODO
      - BV.Core.Utils.IncludeExcludeFilter
    dependencies:
      - sel4-bv:smtlib2
      - sel4-bv:utils
      # external
      - file-embed
      - split
      - vector-binary-instances
      # TODO for debugging
      - pretty-show
      # - pretty-simple

  concrete-syntax:
    visibility: public
    source-dirs: components/concrete-syntax
    exposed-modules:
      - BV.ConcreteSyntax
    dependencies:
      - sel4-bv:core
      - sel4-bv:smtlib2
      # external
      - aeson
      - aeson-pretty
      - attoparsec
      - dlist
      - megaparsec

  utils:
    visibility: public
    source-dirs: components/utils
    exposed-modules:
      - BV.Utils

  target-dir:
    visibility: public
    source-dirs: components/target-dir
    exposed-modules:
      - BV.TargetDir
    dependencies:
      - sel4-bv:core
      - sel4-bv:concrete-syntax
      # external
      - aeson

  system-utils:
    visibility: public
    source-dirs: components/system-utils
    # exposed-modules: # TODO
    dependencies:
      - sel4-bv:logging
      # external
      - distributed-process

  system-core:
    visibility: public
    source-dirs: components/system-core
    exposed-modules:
      - BV.System.Core
      - BV.System.Core.Utils.Logging # TODO
    dependencies:
      - sel4-bv:smtlib2
      - sel4-bv:smtlib2-process
      - sel4-bv:logging
      - sel4-bv:core
      - sel4-bv:search-core
      - sel4-bv:concrete-syntax
      - sel4-bv:utils
      - sel4-bv:system-utils
      # external
      - base16-bytestring
      - cryptohash-sha256

  search-core:
    visibility: public
    source-dirs: components/search/search-core
    exposed-modules:
      - BV.Search.Core
      - BV.Search.Core.Solver
    dependencies:
      - sel4-bv:smtlib2
      - sel4-bv:logging
      - sel4-bv:core
      - sel4-bv:utils

  search-system-core:
    visibility: public
    source-dirs: components/search/search-system-core
    exposed-modules:
      - BV.Search.System.Core
    dependencies:
      - sel4-bv:smtlib2
      - sel4-bv:smtlib2-process
      - sel4-bv:logging
      - sel4-bv:core
      - sel4-bv:search-core
      - sel4-bv:utils
      - sel4-bv:system-utils
      - sel4-bv:system-core

  system:
    visibility: public
    source-dirs: components/system
    # exposed-modules: # TODO
    dependencies:
      - sel4-bv:smtlib2
      - sel4-bv:smtlib2-process
      - sel4-bv:logging
      - sel4-bv:core
      - sel4-bv:search-core
      - sel4-bv:concrete-syntax
      - sel4-bv:target-dir
      - sel4-bv:utils
      - sel4-bv:system-utils
      - sel4-bv:system-core
      # external
      - distributed-process
      - distributed-process-async
      - network-transport
      - sqlite-simple

  test-utils:
    source-dirs: components/tests/test-utils
    dependencies:
      - sel4-bv:logging
      - sel4-bv:core
      - sel4-bv:concrete-syntax
      - sel4-bv:target-dir
      # external
      - optparse-applicative
      - resourcet
      - tasty
      - tasty-hunit
      # TODO prune
      - pretty-show
      # - pretty-simple

executables:

  sel4-bv-cli:
    source-dirs: components/cli
    main: BV.CLI.Main
    dependencies:
      - sel4-bv:smtlib2
      - sel4-bv:smtlib2-process
      - sel4-bv:logging
      - sel4-bv:core
      - sel4-bv:search-core
      - sel4-bv:concrete-syntax
      - sel4-bv:target-dir
      - sel4-bv:utils
      - sel4-bv:system-utils
      - sel4-bv:system
      - sel4-bv:system-core
      - sel4-bv:network-transport-static
      # external
      - aeson
      - ansi-terminal
      - attoparsec
      - base16-bytestring
      - conduit
      - conduit-extra
      - distributed-process
      - distributed-process-async
      - megaparsec
      - network-transport
      - optparse-applicative
      - resourcet
      - yaml
      # TODO for debugging
      - pretty-simple
    ghc-options: *exe-ghc-options

tests:

  smtlib2-test:
    source-dirs: components/tests/smtlib2-test
    main: Main
    dependencies:
      - sel4-bv:smtlib2
      - sel4-bv:smtlib2-process
      - sel4-bv:target-dir
      - sel4-bv:test-utils
      # external
      - attoparsec
      - megaparsec
      - Glob
      - tasty
      - tasty-hunit
    ghc-options: *test-ghc-options

  logging-test:
    source-dirs: components/tests/logging-test
    main: Main
    dependencies:
      - sel4-bv:logging
      - sel4-bv:test-utils
      # external
      - aeson
      - attoparsec
      - attoparsec-aeson
      - tasty
      - tasty-hunit
    ghc-options: *test-ghc-options

  core-test:
    source-dirs: components/tests/core-test
    main: Main
    dependencies:
      - sel4-bv:core
      - sel4-bv:concrete-syntax
      - sel4-bv:target-dir
      - sel4-bv:system
      - sel4-bv:system-core
      - sel4-bv:test-utils
      # external
      - tasty
      - tasty-hunit
    ghc-options: *test-ghc-options

  concrete-syntax-test:
    source-dirs: components/tests/concrete-syntax-test
    main: Main
    dependencies:
      - sel4-bv:core
      - sel4-bv:concrete-syntax
      - sel4-bv:target-dir
      - sel4-bv:test-utils
      # external
      - aeson
      - attoparsec
      - Glob
      - megaparsec
      - tasty
      - tasty-hunit
    ghc-options: *test-ghc-options

  system-test:
    source-dirs: components/tests/system-test
    main: Main
    dependencies:
      - sel4-bv:system
      - sel4-bv:system-core
      - sel4-bv:test-utils
    ghc-options: *test-ghc-options

  search-test:
    source-dirs: components/tests/search-test
    main: Main
    dependencies:
      - sel4-bv:core
      - sel4-bv:search-core
      - sel4-bv:concrete-syntax
      - sel4-bv:target-dir
      - sel4-bv:system
      - sel4-bv:system-core
      - sel4-bv:search-system-core
      - sel4-bv:system-utils
      - sel4-bv:smtlib2
      - sel4-bv:smtlib2-process
      - sel4-bv:test-utils
      - sel4-bv:logging
      # external
      - resourcet
      - tasty
      - tasty-hunit
    ghc-options: *test-ghc-options

# NOTES

# - pretty-show
# - pretty-simple
